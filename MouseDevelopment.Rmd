## 
We will compare the development of mouse hippocampal cells at different ages of mice. These samples were collected as controls for various other projects. 

FA: 21-days (n=2) ("young" mice)
CFC: 12-15 weeks (n=2) ("adult" mice)


```{r}
#Load packages used in other projects; some are currently unused but are included as they may be useful in the future. 

library(Seurat)
library(SeuratObject) 
library(hdf5r) 
library(rlang)
library(ggplot2)
library(harmony)
library(RColorBrewer)
library(tidyverse)
library(patchwork)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(ggvenn)
library(ComplexUpset)
library(clustree)
```
###Step 1a - Load Adult Mice Data
First, we will load the data for the adult mice. There were 2 individuals used as controls, so we will load each individually and then merge the datasets.

```{r}
adult_1 <- Load10X_Spatial(
  data.dir = "C:/Users/Spouse/Documents/Research/Xie/CFC/Spatial/home_cage_rep1/outs/",
  filename = "filtered_feature_bc_matrix.h5",
  assay = "Spatial",
  filter.matrix = TRUE, #only deal with spots over tissue
  image = '/spatial',
)
adult_1$orig.ident <- "adult_1"

adult_2 <- Load10X_Spatial(
  data.dir = "C:/Users/Spouse/Documents/Research/Xie/CFC/Spatial/home_cage_rep2/outs/",
  filename = "filtered_feature_bc_matrix.h5",
  assay = "Spatial",
  filter.matrix = TRUE, #only deal with spots over tissue
  image = '/spatial',
)
adult_2$orig.ident <- "adult_2"

merge.obj <- merge(adult_1,c(adult_2),
                   add.cell.ids = c("adult_1","adult_2"))
```
###Step 1b - Load Young Mice Data & Merge All Mice Data
Now we will merge the data for the adult mice with the data for the young mice. The young mice data was shared via a Seurat object of the two merged repetitions.

```{r}
load("~/Research/Xie/High Folate/Control.Rdata")
merge.obj <- merge(merge.obj,c(controls),
                   add.cell.ids = c("adult","young"))
```

##Step 2a - Summary Statistics & Quality Control Check
Let's check the genes per spot and UMIs per spot to verify the integrity of the data. Let's also examine the distribution of genes per spot and UMIs per spot across reads to ensure the quality of the dataset.

```{r}
summary(merge.obj$nFeature_Spatial)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#    220    4955    5838    5848    6758   10180 

summary(merge.obj$nCount_Spatial)
#   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#    237   11612   15946   18046   22085   80922 

#The standard is to remove spots with less than 250 genes per spot, as these are low quality reads. Let's see how many spots are low quality reads in this dataset. 

sum(merge.obj$nFeature_Spatial <= 250) #1 - Excellent!

#Likewise, it is standard to remove spots with less than 500 UMIs per spot. Let's see how frequently this occurred. 

sum(merge.obj$nCount_Spatial <= 500) #4 - Great again!

#Let's also visualize the distribution of genes per spot and UMIs per spot with a violin plot.

metadata <- merge.obj@meta.data

p1 <- ggplot(metadata, aes(x = "Genes per Spot", y = nFeature_Spatial)) +
  geom_violin(fill = "maroon", color = "black", alpha = 0.5) +
  geom_jitter(alpha = 0.2) +
  ggtitle("Genes per Spot in Merged Data") +
  theme_minimal() +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = 0.5), #Center the title
        axis.title.x = element_blank(), #Remove x-axis title
        axis.title.y = element_blank(), #Remove x-axis title
        axis.text.x = element_blank())  #Remove x-axis text
#This looks great


p2 <- ggplot(metadata, aes(x = "UMIs per Spot in Merged Data", y = nCount_Spatial)) +
  geom_violin(fill = "orange", color = "black") +
  geom_jitter(alpha = 0.2) +
  ggtitle("UMIs per Spot in Merged Data") +
  theme_minimal() +
  theme(legend.position = "none", 
        plot.title = element_text(hjust = 0.5), #Center the title
        axis.title.x = element_blank(), #Remove x-axis title
        axis.title.y = element_blank(), #Remove x-axis title
        axis.text.x = element_blank())  #Remove x-axis text
#Looks good, let's proceed.


```
###Step 2b - Remove Low Quality Spots & Normalize

Let's remove the lowest quality spots (i.e. <=250 genes or <=500 UMIs per spot), normalize via counts per million, select the 3000 most frequent genes and scale the expression values of genes.
```{r}
#Remove the lowest quality spots (Genes <=250 or UMIs <= 500)
merge.obj <- subset(merge.obj, subset = nFeature_Spatial > 250 & nCount_Spatial > 500)

#Normalize to gene frequency in Counts per Million (CPM)
merge.obj <- NormalizeData(merge.obj, assay = "Spatial", scale.factor = 10**6) 

#Next, let's reduce our dataset to focus on only the 3000 genes of highest relative abundance.
merge.obj <- FindVariableFeatures(merge.obj, assay = "Spatial", nfeatures = 3000) 
#Scale the expression values of genes 
merge.obj <- ScaleData(merge.obj, assay = "Spatial", features = rownames(merge.obj))
```
###Step 3a - Noise Reduction - PCA
Let's select the 20 most common PC's and graph an elbow plot to look for a breakpoint. 

```{r}
merge_PCA <- RunPCA(merge.obj, assay = "Spatial", npcs = 20, features = rownames(merge.obj))

ElbowPlot(merge_PCA,ndims = 20) + 
  geom_hline(yintercept = 4.75) + #This may be our breakpoint
  scale_y_continuous(breaks = c(3,5,10,15,20))
```
###Step 3b - Noise Reduction - Harmony
Using visual analysis of the above, 10, 12, 15, or 19 could be used as breakpoints. Let's proceed with 10 PC's. 

Next, let's perform harmony to reduce the noise from joining separate datasets.

```{r}
merge.obj <- RunHarmony(merge_PCA, "orig.ident", dims.use = 1:10, assay.use = "Spatial") 
plotHarmony <- ElbowPlot(merge.obj, ndims = 10, reduction = "harmony") + 
  geom_hline(yintercept = 3) +
  scale_y_continuous(breaks = c(3, 5, 10, 15))
plotHarmony
```
###Step 4a - Clustering - UMAP
The 6th component of Harmony was less than the 7th component of Harmony. This is possible but unusual. Harmony is not essential for UMAP, so let's examine the UMAP with and without Harmony. 

```{r}
#Without Harmony
merge_UMAP_PCA <- RunUMAP(merge_PCA, dims = 1:10)
UMAP_PCA <-DimPlot(merge_UMAP_PCA, group.by = "orig.ident")
#This doesn't look good. There is a strong batch effect.

#With Harmony
#merge.obj <- RunUMAP(merge.obj, dims = 1:10, reduction = "harmony")
#plot - overlay all 4 controls on a single plot
#UMAP_harmony <- DimPlot(merge.obj, group.by = "orig.ident")
#Let's try proceeding without Harmony

merge.obj <- merge_UMAP_PCA


```
###Step 4b - Clustering - Clustree

```{r}
#clustering with pca only, without harmony
merge.obj <- FindNeighbors(merge.obj, reduction = "pca", dims = 1:10)
merge.obj <- FindClusters(merge.obj, resolution = c(0.05, 0.075, 0.1, 0.15, 0.2, 0.25, 0.3), algorithm = 3)
clustree(merge.obj)


#FindClusters algorithm default is Louvain
#algorithm = 3 is SLM (smart local moving algorithm)

#Let's skip SLM for now
#SLM was used in the HF paper. Let's try that. 
#merge.obj_slm <- FindClusters(merge.obj, resolution = c(0.05, 0.075, 0.1, 0.15, 0.2, 0.25, 0.3), algorithm = 3)
#clustree(merge.obj_slm)
```
Other analyses within our lab of mouse brains have used 6 clusters. This corresponds to 0.1. 

Original issues: 
1. Only 2 images viewable. I need to download the adult images. (resolved)
2. Poor resolution of spatialdimplots; spots too small - It took some time to resolve this. (resolved)
3. Poor clustering. 

```{r}
#SpatialDimPlot of the SLM method
#slm_dim_0.1 <- SpatialDimPlot(merge.obj, group.by = "Spatial_snn_res.0.1", ncol = 4,label = F, image.alpha = 1, alpha = 1, pt.size.factor = 740)

#SpatialDimPlot of Louvian method
dim_0.1 <- SpatialDimPlot(merge.obj, group.by = "Spatial_snn_res.0.1", ncol = 4,label = F, image.alpha = 1, alpha = 1, pt.size.factor = 740)
#ggsave("SpatialRes0.1.png")



ggsave("~/Xie/MouseDevelopment/Figures/SpatialDmPlot.cluster.tiff", device='tiff', dpi=500)
```


```{r}

```